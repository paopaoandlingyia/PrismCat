## 项目定位（一句话）
做一个**本地可长期运行的 LLM Logging Reverse Proxy**：只做**透传 + 记录请求/响应（含流式）**，支持 OpenAI 与 Gemini，上游固定可配置。

---

## 核心目标（MVP 必须有）
1) **透传**：请求原样转发到上游，响应原样返回给调用方  
2) **可观测**：记录“真实请求体”和“真实响应体”（重点支持 streaming/SSE）  
3) **长期运行**：稳定、不会因为日志或流式处理把自己卡死  
4) **多上游选择**：不用 URL-in-path，改用“Host 路由”（子域名思路）

---

## 推荐入口形式（本地不搞证书的子域名方案）
- 使用 `*.localhost`（通常会解析到 127.0.0.1，无需 DNS 配置）
- 网关监听 HTTP：`http://0.0.0.0:8080`

调用方式：
- OpenAI：`http://openai.localhost:8080/...`  → upstream `https://api.openai.com/...`
- Gemini：`http://gemini.localhost:8080/...` → upstream `https://generativelanguage.googleapis.com/...`

说明：网关根据请求的 `Host`（openai.localhost / gemini.localhost）选择上游。SDK 侧只需要改 baseURL，路径保持原样。

> 未来上云/开源：把入口换成真实域名 + HTTPS（证书可以交给 Cloudflare/Caddy/平台托管），网关逻辑不变。

---

## 技术选型建议
- 语言：**Go**（落地最快，HTTP/流式处理方便）
- 代理骨架：`net/http` + `httputil.ReverseProxy`
- 运行模式：单进程即可（个人使用），后续可容器化

---

## 路由与转发规则（固定上游，避免 open proxy）
- 仅支持已配置的 upstream（例如 `openai`、`gemini`）
- 禁止用户指定任意目标 URL（不做 URL-in-path）
- 允许通过 Host 或路径前缀选择 upstream（MVP 用 Host）

---

## 日志：记录什么、怎么记（很关键）
### 记录内容（建议 JSONL 一行一条）
- 时间戳、request_id
- upstream（openai/gemini）
- method、path、query
- 请求头（脱敏后）、响应头（可选）
- status_code、latency_ms
- request_body（截断 + 可选脱敏）
- response_body（截断 + streaming 拼接后的最终文本/JSON）
- streaming 标记（是否 chunked/SSE）
- 失败信息（上游超时/连接错误等）

### 脱敏/截断建议（MVP 也要做）
- `Authorization`、`x-api-key` 等全部打码
- body 设置最大记录长度（比如 1MB），超出写 `truncated: true`

---

## Streaming / SSE 处理原则（LLM 必备）
- **不能全量 buffer 后再返回**（会破坏实时性）
- 做“边读边转发、同时复制一份到日志”的 tee：
  - 响应 `Body` 包一层 `ReadCloser`：每次 `Read()` 的 chunk 追加到日志缓冲，同时把 chunk 立刻写给客户端
  - 尽量 flush（对 `http.Flusher`）
- 最终在请求结束时，把拼接到的完整响应写入日志（或写入“chunks 数组/拼接文本”，二选一）

---

## HTTP 行为细节（避免坑）
- 上游请求头处理：
  - 透传大部分 header
  - 自己设置正确的 `Host`（上游域名）
  - `Authorization` 透传（但日志要脱敏）
- 重定向：
  - **默认不跟随**上游 30x（更可控）
  - 如需跟随，必须再次校验目标（后续再做）
- 超时：
  - 配置合理的 dial / tls / response header timeout（避免挂死）

---

## 配置方式（建议）
- 配置文件或环境变量：
  - `OPENAI_UPSTREAM=https://api.openai.com`
  - `GEMINI_UPSTREAM=https://generativelanguage.googleapis.com`
  - `LISTEN_ADDR=:8080`
  - `LOG_DIR=...`、`MAX_BODY_BYTES=...`
- 可选：开启一个 `/healthz`

---

## 开发里程碑（按这个顺序最顺）
1) **Host 路由 + 基本反代**（先让 OpenAI/Gemini 都通）
2) **记录 request/response headers + latency**
3) **记录 request body（注意读 body 不要影响转发）**
4) **流式响应 tee 记录（SSE/chunked）**
5) **脱敏 + 截断 + 日志轮转**
6) （可选）简单查询 UI/本地页面或导出工具

---

## 非目标（先别做）
- 通用 URL-in-path 任意转发（安全边界复杂）
- 复杂鉴权/RBAC（本地先不需要）
- 高并发优化/分布式存储（后面再说）
